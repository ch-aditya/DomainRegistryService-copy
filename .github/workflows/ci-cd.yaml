name: CI-CD
on:
  push:
    tags:
      - 'v*'
    branches: ["main","develop","release/**"]
  pull_request:
    types: [opened]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: architect-learning-435310
  REGION: asia-south1
  REPO_NAME: domain-registry-repo
  AUTH_SERVICE_ACCOUNT: domain-registry-auth-sa@architect-learning-435310.iam.gserviceaccount.com

jobs:
  deploy_to_artifact_registry:
    runs-on: ubuntu-latest
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '21'
          cache: 'gradle'

      - name: Install Dependencies
        run: ./gradlew build --no-daemon

      # Authenticate to Google Cloud using Workload Identity Federation (WIF)
      - name: Authenticate to GCP using Workload Identity Federation
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/342909886583/locations/global/workloadIdentityPools/domain-registry-service/providers/git-repo-provider"
          service_account: ${{env.AUTH_SERVICE_ACCOUNT}}

      # Set up gcloud CLI (Optional, but helpful for BigQuery, GCS, etc.)
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: ">= 363.0.0"

      - name: 'Use gcloud CLI'
        run: 'gcloud info'

      # Authenticate Docker with GCP's Artifact Registry (or Container Registry)
      - name: Docker Auth
        run: |-
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # Extract the tag version
      - name: Get tag version
        id: get_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/release/}" >> $GITHUB_ENV

      # Build Docker image
      - name: Build Docker image
        run: |-
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/my-app:${{ env.TAG_NAME }} .

      # Push Docker image to GCP Artifact Registry
      - name: Push Docker image
        run: |-
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/domain-registry-service:${{ env.TAG_NAME }}